# Спецификация API "Nexus Capital" (v6.0)

Этот документ описывает RESTful API и WebSocket API для серверной части бизнес-симулятора "Nexus Capital". Бэкенд является единственным источником правды, отвечает за всю бизнес-логику, хранение данных и безопасность.

## 1. Обзор архитектуры

- **Стек:** Node.js, Express/NestJS, PostgreSQL/MongoDB.
- **Аутентификация:** JSON Web Tokens (JWT).
- **Real-time:** WebSocket для живой ленты событий.
- **Формат данных:** Все запросы и ответы используют формат `application/json`.
- **Базовый URL:** `/api`

---

## 2. Аутентификация

Доступ ко всем эндпоинтам (кроме `/auth/login` и `/auth/register`) требует аутентификации.

### Схема JWT:
1.  **Логин:** Клиент отправляет `email` и `password` на `POST /api/auth/login`.
2.  **Получение токенов:** В ответ сервер возвращает пару токенов:
    - `accessToken`: Короткоживущий токен (например, 15 минут) для авторизации запросов.
    - `refreshToken`: Долгоживущий токен (например, 30 дней) для обновления `accessToken`.
3.  **Авторизация:** Для каждого защищенного запроса клиент должен передавать `accessToken` в заголовке:
    `Authorization: Bearer <accessToken>`
4.  **Обновление токена:** Если `accessToken` истек (сервер отвечает `401 Unauthorized`), клиент отправляет `refreshToken` на эндпоинт `POST /api/auth/refresh` для получения новой пары токенов.

---

## 3. Спецификация REST API

### 3.1. Ресурс: Partners (`/api/partners`)

Управление данными пользователей (Партнеров).

| Метод | Эндпоинт           | Описание                                  |
| :---- | :----------------- | :---------------------------------------- |
| `GET` | `/me`              | Получить данные текущего Партнера.        |
| `PUT` | `/me`              | Обновить профиль текущего Партнера.       |
| `GET` | `/:id`             | Получить публичные данные Партнера по ID. |
| `GET` | `/me/network`      | Получить список Партнеров в своей сети.   |

#### `GET /api/partners/me`
- **Описание:** Возвращает полный объект `Partner` для авторизованного пользователя.
- **Ответ `200 OK`:**
  ```json
  {
    "id": "U12345",
    "name": "Алексей Волков",
    "avatarUrl": "https://...",
    "level": 5,
    "capital": 875.75,
    "reputation": 1250,
    "rank": "Партнер",
    // ... все поля из типа Partner
  }
  ```

#### `PUT /api/partners/me`
- **Описание:** Обновляет изменяемые поля профиля.
- **Тело запроса:**
  ```json
  {
    "name": "Алексей Волков",
    "avatarUrl": "https://...",
    "bio": "Новое описание...",
    "socials": {
      "telegram": "alex_volkov",
      "vk": "alex_volkov_vk"
    }
  }
  ```
- **Ответ `200 OK`:** Обновленный объект `Partner`.

---

### 3.2. Ресурс: Projects (`/api/projects`)

Управление Проектами пользователя.

| Метод  | Эндпоинт           | Описание                                    |
| :----- | :----------------- | :------------------------------------------ |
| `GET`  | `/`                | Получить список всех Проектов пользователя. |
| `POST` | `/:id/activate`    | Активировать выбранный Проект.              |

#### `POST /api/projects/:id/activate`
- **Описание:** Делает Проект с указанным `:id` активным. Требует списания `entryCost` с баланса `$CAP`.
- **Тело запроса:** (пустое)
- **Ответ `200 OK`:** Обновленный список всех `Project` пользователя.
- **Ошибки:** `400 Bad Request` (недостаточно средств, проект уже активен).

---

### 3.3. Ресурс: Transactions (`/api/transactions`)

Финансовые операции с капиталом ($CAP).

| Метод  | Эндпоинт     | Описание                                               |
| :----- | :----------- | :----------------------------------------------------- |
| `GET`  | `/`          | Получить историю транзакций (с пагинацией).            |
| `POST` | `/deposit`   | Создать заявку на покупку $CAP (вернуть адрес для оплаты). |
| `POST` | `/withdraw`  | Создать заявку на продажу $CAP.                        |
| `POST` | `/transfer`  | Выполнить внутренний перевод другому Партнеру.         |

#### `POST /api/transactions/transfer`
- **Описание:** Переводит $CAP от текущего пользователя другому. Включает комиссию.
- **Тело запроса:**
  ```json
  {
    "recipientId": "U67890",
    "amount": 100.00,
    "comment": "Спасибо за помощь!"
  }
  ```
- **Ответ `201 Created`:** Созданный объект `Transaction`.
- **Ошибки:** `400 Bad Request` (недостаточно средств), `404 Not Found` (получатель не найден).

---

### 3.4. Ресурс: AI (`/api/ai`)

Безопасные вызовы к Gemini API через бэкенд.

| Метод  | Эндпоинт              | Описание                                  |
| :----- | :-------------------- | :---------------------------------------- |
| `POST` | `/generate-content`   | Сгенерировать маркетинговый текст.       |
| `POST` | `/generate-image`     | Сгенерировать промо-баннер.             |
| `GET`  | `/analyze-network`    | Получить AI-анализ своей Бизнес-сети.   |

#### `POST /api/ai/generate-content`
- **Описание:** Принимает промпт, вызывает Gemini API с системными инструкциями и возвращает результат в виде потока (stream).
- **Тело запроса:**
  ```json
  {
    "prompt": "Напиши короткий рекламный пост для Telegram о Nexus Capital"
  }
  ```
- **Ответ `200 OK`:** `Content-Type: text/plain; charset=utf-8` с потоковым ответом от AI.

---

### 3.5. Прочие ресурсы

- **`GET /api/leaderboard`**: Возвращает массив объектов `Leader`.
- **`GET /api/stats/market`**: Возвращает объект `MarketStats`.
- **`GET /api/missions`**: Возвращает массив `Mission` для пользователя.
- **`POST /api/missions/:id/claim`**: Позволяет забрать награду за выполненную миссию.
- **`GET /api/chat/messages`**: Получить историю сообщений чата.

---

## 4. WebSocket API

Для обновлений в реальном времени (Живая лента) используется WebSocket.

- **URL для подключения:** `wss://nexus.capital/api/livefeed?token=<accessToken>`
- **Авторизация:** JWT токен передается как query-параметр при подключении.

### События от сервера (Server-to-Client)

Сервер отправляет JSON-сообщения со следующей структурой:
```json
{
  "event": "feed_update",
  "payload": {
    "id": "EVT001",
    "type": "registration",
    "user": {
      "name": "Елена С.",
      "avatarUrl": "https://..."
    },
    "amount": null,
    "timestamp": "2024-07-28T12:00:00.000Z",
    "level": null
  }
}
```

**Типы событий (`payload.type`):**
- `registration`
- `new_level`
- `withdrawal`
- `deposit`
- `funding_completed`
- `upgrade`

### События от клиента (Client-to-Server)

Для общего чата используется WebSocket для отправки сообщений.

- **Событие:** `chat_message`
- **Payload:**
  ```json
  {
    "text": "Всем привет!",
    "replyTo": "MSG001" // опционально
  }
  ```
---

## 5. Модели данных (Types)

Основные типы данных, используемые в API, описаны в файле `types.ts` фронтенд-приложения. Бэкенд должен придерживаться этих же структур для консистентности.

- `Partner`: Основная модель пользователя.
- `Project`: Модель инвестиционного Проекта.
- `Transaction`: Модель финансовой операции.
- `Mission`: Модель миссии или задачи.
- `ChatMessage`: Модель сообщения в чате.

---

## 6. Обработка ошибок

API использует стандартные HTTP-коды состояния для индикации успеха или неудачи запроса.

- `200 OK`: Запрос успешно выполнен.
- `201 Created`: Ресурс успешно создан.
- `400 Bad Request`: Ошибка валидации на стороне клиента (например, неверный формат данных).
- `401 Unauthorized`: Ошибка аутентификации (неверный или истекший `accessToken`).
- `403 Forbidden`: У пользователя нет прав на выполнение данного действия.
- `404 Not Found`: Запрашиваемый ресурс не найден.
- `500 Internal Server Error`: Ошибка на стороне сервера.

Тело ответа при ошибке должно содержать полезную информацию:
```json
{
  "statusCode": 400,
  "message": "Недостаточно средств на балансе.",
  "error": "Bad Request"
}
```
